<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard PWA Demo - Final Integration Test</title>

    <!-- PWA Integration - START -->
    <link rel="manifest" href="/dashboard-manifest.json" />
    <meta name="theme-color" content="#3b82f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Pigeon Map Dashboard" />
    <link rel="apple-touch-icon" href="/dashboard-icon-192.png" />
    <!-- PWA Integration - END -->

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .header {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        text-align: center;
      }
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .status-card {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .status-success {
        border-left: 4px solid #10b981;
      }
      .status-warning {
        border-left: 4px solid #f59e0b;
      }
      .status-error {
        border-left: 4px solid #ef4444;
      }
      .status-info {
        border-left: 4px solid #3b82f6;
      }

      .button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
        transition: background 0.2s;
      }
      .button:hover {
        background: #2563eb;
      }
      .button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .logs {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 15px;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }

      .install-banner {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        display: none;
      }

      .feature-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .feature-item {
        background: #f1f5f9;
        padding: 15px;
        border-radius: 6px;
        border-left: 3px solid #3b82f6;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üê¶ Pigeon Map Dashboard PWA</h1>
      <p>Final Integration Test & Demonstration</p>
      <div id="connection-status">Checking PWA status...</div>
    </div>

    <div class="install-banner" id="install-banner">
      <strong>üì± Install Dashboard App</strong>
      <p>You can install this dashboard as a standalone app on your device!</p>
      <button class="button" onclick="installApp()">Install App</button>
      <button
        class="button"
        onclick="hideInstallBanner()"
        style="background: #6b7280"
      >
        Not Now
      </button>
    </div>

    <div class="status-grid">
      <div class="status-card status-info">
        <h3>üîß PWA Status</h3>
        <div id="pwa-status">
          <p id="sw-status">
            Service Worker: <span id="sw-state">Loading...</span>
          </p>
          <p id="manifest-status">
            Manifest: <span id="manifest-state">Loading...</span>
          </p>
          <p id="install-status">
            Installation: <span id="install-state">Loading...</span>
          </p>
          <p id="standalone-status">
            Standalone Mode: <span id="standalone-state">Loading...</span>
          </p>
        </div>
      </div>

      <div class="status-card status-success">
        <h3>üìä App Features</h3>
        <div class="feature-list">
          <div class="feature-item">
            <strong>Offline Support</strong><br />
            <small>Works without internet connection</small>
          </div>
          <div class="feature-item">
            <strong>App-like Experience</strong><br />
            <small>Fullscreen, no browser UI</small>
          </div>
          <div class="feature-item">
            <strong>Fast Loading</strong><br />
            <small>Cached resources for instant access</small>
          </div>
          <div class="feature-item">
            <strong>Install Prompt</strong><br />
            <small>Add to home screen functionality</small>
          </div>
        </div>
      </div>
    </div>

    <div class="status-card">
      <h3>üéÆ PWA Controls</h3>
      <button class="button" onclick="checkServiceWorker()">
        Check Service Worker
      </button>
      <button class="button" onclick="testCaching()">Test Caching</button>
      <button class="button" onclick="checkManifest()">
        Validate Manifest
      </button>
      <button class="button" onclick="forceUpdate()">Force Update</button>
      <button class="button" onclick="clearCache()">Clear Cache</button>
    </div>

    <div class="status-card">
      <h3>üìã Integration Example</h3>
      <p>
        This page demonstrates how to integrate PWA functionality into your
        dashboard application.
      </p>
      <details>
        <summary><strong>HTML Head Integration</strong></summary>
        <pre
          style="
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
          "
        ><code>&lt;!-- PWA Integration --&gt;
&lt;link rel="manifest" href="/dashboard-manifest.json"&gt;
&lt;meta name="theme-color" content="#3b82f6"&gt;
&lt;meta name="apple-mobile-web-app-capable" content="yes"&gt;
&lt;meta name="apple-mobile-web-app-title" content="Pigeon Map Dashboard"&gt;
&lt;link rel="apple-touch-icon" href="/dashboard-icon-192.png"&gt;

&lt;!-- Load PWA Script --&gt;
&lt;script src="/dashboard-pwa.js"&gt;&lt;/script&gt;</code></pre>
      </details>
    </div>

    <div class="status-card">
      <h3>üìù Activity Log</h3>
      <div id="logs" class="logs">Initializing PWA test environment...\n</div>
    </div>

    <!-- PWA Script Integration -->
    <script src="/dashboard-pwa.js"></script>

    <script>
      let installPrompt = null;

      function log(message) {
        const logs = document.getElementById("logs");
        const timestamp = new Date().toISOString().split("T")[1].split(".")[0];
        logs.textContent += `[${timestamp}] ${message}\n`;
        logs.scrollTop = logs.scrollHeight;
      }

      function updateStatus(elementId, status, className = "") {
        const element = document.getElementById(elementId);
        element.textContent = status;
        if (className) {
          element.className = className;
        }
      }

      function checkServiceWorker() {
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.ready
            .then((registration) => {
              log("‚úÖ Service Worker is active and ready");
              log(`   Scope: ${registration.scope}`);
              log(`   State: ${registration.active.state}`);
              updateStatus("sw-state", "‚úÖ Active");
            })
            .catch((error) => {
              log(`‚ùå Service Worker error: ${error.message}`);
              updateStatus("sw-state", "‚ùå Error");
            });
        } else {
          log("‚ùå Service Worker not supported in this browser");
          updateStatus("sw-state", "‚ùå Not Supported");
        }
      }

      function testCaching() {
        log("üîÑ Testing cache functionality...");

        // Test manifest caching
        fetch("/dashboard-manifest.json")
          .then((response) => {
            const fromCache = response.headers.get("cache-control")
              ? "cache"
              : "network";
            log(`üìÑ Manifest loaded from: ${fromCache}`);
          })
          .catch((error) => log(`‚ùå Manifest fetch failed: ${error.message}`));

        // Test icon caching
        fetch("/dashboard-icon-192.png")
          .then((response) => {
            log(`üñºÔ∏è  Icon loaded successfully (${response.status})`);
          })
          .catch((error) => log(`‚ùå Icon fetch failed: ${error.message}`));
      }

      function checkManifest() {
        fetch("/dashboard-manifest.json")
          .then((response) => response.json())
          .then((manifest) => {
            log("üìã Manifest validation:");
            log(`   Name: ${manifest.name}`);
            log(`   Scope: ${manifest.scope}`);
            log(`   Start URL: ${manifest.start_url}`);
            log(`   Display: ${manifest.display}`);
            log(`   Icons: ${manifest.icons.length} defined`);
            updateStatus("manifest-state", "‚úÖ Valid");
          })
          .catch((error) => {
            log(`‚ùå Manifest validation failed: ${error.message}`);
            updateStatus("manifest-state", "‚ùå Invalid");
          });
      }

      function forceUpdate() {
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.ready
            .then((registration) => {
              log("üîÑ Checking for service worker updates...");
              return registration.update();
            })
            .then(() => {
              log("‚úÖ Service worker update check completed");
            })
            .catch((error) => {
              log(`‚ùå Update check failed: ${error.message}`);
            });
        }
      }

      function clearCache() {
        if ("caches" in window) {
          caches
            .keys()
            .then((cacheNames) => {
              log(`üóëÔ∏è  Clearing ${cacheNames.length} cache(s)...`);
              return Promise.all(
                cacheNames.map((cacheName) => {
                  log(`   Clearing cache: ${cacheName}`);
                  return caches.delete(cacheName);
                })
              );
            })
            .then(() => {
              log("‚úÖ All caches cleared");
            })
            .catch((error) => {
              log(`‚ùå Cache clearing failed: ${error.message}`);
            });
        }
      }

      function installApp() {
        if (window.installPWA) {
          log("üì± Triggering PWA installation...");
          window.installPWA();
        } else if (installPrompt) {
          log("üì± Showing install prompt...");
          installPrompt.prompt();
          installPrompt.userChoice.then((result) => {
            log(`üì± User choice: ${result.outcome}`);
            installPrompt = null;
            hideInstallBanner();
          });
        } else {
          log("‚ùå Install prompt not available");
        }
      }

      function hideInstallBanner() {
        document.getElementById("install-banner").style.display = "none";
      }

      // Initialize PWA status checking
      window.addEventListener("load", () => {
        log("üöÄ PWA Demo initialized");

        // Check standalone mode
        const isStandalone = window.isPWAInstalled
          ? window.isPWAInstalled()
          : window.matchMedia("(display-mode: standalone)").matches;
        updateStatus("standalone-state", isStandalone ? "‚úÖ Yes" : "‚ùå No");

        // Check installation status
        if (isStandalone) {
          updateStatus("install-state", "‚úÖ Installed");
          document.getElementById("connection-status").textContent =
            "‚úÖ Running as installed PWA";
        } else {
          updateStatus("install-state", "üåê Web Browser");
          document.getElementById("connection-status").textContent =
            "üåê Running in web browser";
        }

        // Run initial checks
        setTimeout(() => {
          checkServiceWorker();
          checkManifest();
          testCaching();
        }, 1000);
      });

      // Listen for install prompt
      window.addEventListener("beforeinstallprompt", (e) => {
        log("üì± Install prompt available");
        e.preventDefault();
        installPrompt = e;
        document.getElementById("install-banner").style.display = "block";
      });

      // Listen for successful installation
      window.addEventListener("appinstalled", () => {
        log("üéâ PWA successfully installed!");
        updateStatus("install-state", "‚úÖ Installed");
        hideInstallBanner();
      });

      // Override console.log to capture PWA messages
      const originalConsoleLog = console.log;
      console.log = function (...args) {
        if (args[0] && args[0].includes("[PWA]")) {
          log(args.join(" "));
        }
        originalConsoleLog.apply(console, args);
      };

      log("üì± PWA Integration Demo loaded successfully");
    </script>
  </body>
</html>
